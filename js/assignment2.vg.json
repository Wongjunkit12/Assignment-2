{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "data": {
    "url": "data/exports_imports_dataset.csv",
    "format": {
      "type": "csv"
    }
  },
  "params": [
    {
      "name": "Year_selection",
      "value": 2000,
      "bind": {
        "input": "range",
        "min": 2000,
        "max": 2020,
        "step": 1,
        "name": "Year: "
      }
    },
    {
      "name": "zoom_level",
      "value": 160,
      "bind": {
        "input": "range",
        "min": 160,
        "max": 640,
        "step": 20,
        "name": "Zoom: "
      }
    },
    {
      "name": "center_to",
      "value": [0, -280],
      "bind": {
        "input": "select",
        "options": [
          [0, -280],
          [130, -11],
          [110, 24],
          [125, 53],
          [-120, 60],
          [35, 60]
        ],
        "labels": ["Center Map", "Australia", "Malaysia", "China", "United States", "Turkey"],
        "name": "Map Centre: "
      }
    },
    { "name": "top_n", 
      "value": 5,
			"bind": {
        "input": "range", 
        "min": 5, 
        "max": 30, 
        "step": 1,
        "name": "Top N: "
      }
		}
  ],
  "vconcat": [
    {
      "title": {
        "text": {
          "signal": "'Balance of Trade (US$ Billions) of Countries in ' + Year_selection"
        },
        "fontSize": 20,
        "fontWeight": "bolder"
      },
      "width": 1000,
      "height": 400,
      "data": {
        "url": "data/exports_imports_dataset.csv",
        "format": {
          "type": "csv"
        }
      },
      "projection": {
        "type": "equalEarth",
        "center": {"expr": "center_to"},
        "scale": {"expr": "zoom_level"}
      },
      "transform": [
        {
          "lookup": "Country",
          "from": {
            "data": {
              "url": "js/countries.topojson",
              "format": {
                "type": "topojson",
                "feature": "countries"
              }
            },
            "key": "properties.NAME"
          },
          "as": "geo"
        },
        {
          "filter": "datum['Year'] == Year_selection"
        }
      ],
      "layer": [
        {
          "data": {
            "url": "js/oceans.topojson",
            "format": {"type": "topojson", "feature": "oceans"}
          },
          "mark": {"type": "geoshape", "fill": "lightcyan"}
        },
        {
          "data": {
            "url": "js/graticules.topojson",
            "format": {"type": "topojson", "feature": "graticules"}
          },
          "mark": {"type": "geoshape", "fill": null, "stroke": "lightgray"}
        },
        {
          "mark": {
            "type": "geoshape",
            "stroke": "gray"
          },
          "encoding": {
            "shape": {
              "field": "geo",
              "type": "geojson"
            },
            "color": {
              "field": "Trade Balance (US$ Billions)",
              "type": "quantitative",
              "title": "Balance of Trade (US$ Billions)",
              "scale": {
                "domainMid": 0,
                "domain": [-1500, -1000, -500, -100, -50, -20, -10, -5, 0, 5, 10, 20, 50, 100, 500, 1000, 1500],
                "range": ["#35000f", "#4e0017", "#67001f", "#7f0038", "#980043", "#b2182b", "#d6604d", "#f4a582", "#ffe7c8", "#d1e5f0", "#abcfe3", "#7ebbd8", "#4393c3", "#1d5997", "#2166ac", "#053061", "#042449"]
              },
              "legend": {
                  "padding": 10
              }
            },
            "tooltip": [
              {"field": "Country", "type": "nominal", "title": "Country"},
              {"field": "Continent", "type": "nominal", "title": "Continent"},
              {"field": "Trade Balance (US$ Billions)", "type": "quantitative", "title": "Balance of Trade (US$ Billions)"}
            ]
          }
        },
        {
          "mark": {
            "type": "text",
            "align": "left",
            "baseline": "middle",
            "dx": -12,
            "fontSize": 11.5,
            "fontWeight": "normal"
          },
          "encoding": {
            "text": {
              "field": "Country",
              "type": "nominal"
            },
            "color" : {
              "value": "black"
            },
            "opacity": {
              "condition": {
                "test": "datum['Country'] == 'China'",
                "value": 0
              },
              "value": 0
            }
          }
        }
      ]
    },
    {
      "title": {
        "text": {
          "signal": "'Trade Volume and GDP of Countries in ' + Year_selection"
        }
      },
      "width": 1000,
      "height": 400,
      "layer": [
        {
          "params":[
            {
              "name": "continent_highlight",
              "select": {"type": "point", "fields": ["Continent"]},
              "bind": "legend"
            }
          ],
          "transform": [
            {
              "filter": "datum.Year == Year_selection"
            }
          ],         
          "mark": "circle",
          "encoding": {
            "x": {
              "field": "Export (US$ Billions)",
              "type": "quantitative",
              "title": "Capital Inflow in Exports in (US$ Billions)",
              "axis": {"tickCount": 6},
              "scale": {"type": "log"}
            },
            "y": {
              "field": "Import (US$ Billions)",
              "type": "quantitative",
              "title": "Capital Outflow in Imports (US$ Billions)",
              "axis": {"tickCount": 6},
              "scale": {"type": "log"}
            },
            "color": {
              "field": "Continent",
              "type": "nominal",
              "title": "Continent",
              "scale": {
                "domain": [
                  "North America",
                  "South America",
                  "Europe",
                  "Africa",
                  "Asia",
                  "Oceania"
                ],
                "range": [
                  "#e41a1c",
                  "#984ea3",
                  "#ff7f00",
                  "#a6cee3",
                  "#377eb8",
                  "#a65628"
                ]
              }
            },
            "opacity": {
              "condition": {"param": "continent_highlight", "value": 0.6},
              "value": 0.2
            },              
            "size": {
              "field":"GDP (US$ Billions)",
              "type": "quantitative",
              "scale": {
                "type": "threshold",
                "domain": [1, 5, 10, 20, 100, 200, 500, 1000, 5000, 10000, 20000],
                "range": [10, 20, 50, 75, 100, 200, 250, 350, 500, 800, 1200]
                },
                "legend": {
                  "format": ".1s",
                  "padding": 10,
                  "orient": "none",
                  "legendX": 1010,
                  "legendY": 560,
                  "values": [1, 5, 10, 20, 100, 200, 500, 1000, 5000, 10000]
                }
            },
            "tooltip": [
              {"field": "Country", "type": "nominal", "title": "Country"},
              {"field": "Continent", "type": "nominal", "title": "Continent"},
              {"field": "Year", "type": "quantitative", "title": "Year"},
              {"field": "Import (US$ Billions)", "type": "quantitative", "title": "Capital Outflow in Imports (US$ Billions)"},
              {"field": "Export (US$ Billions)", "type": "quantitative", "title": "Capital Inflow in Exports (US$ Billions)"},
              {"field": "GDP (US$ Billions)", "type": "quantitative", "title": "Gross Domestic Product (US$ Billions)"}
            ]
          }
        }
      ]
    },
    {
      "title": {
        "text": {
          "signal": "'Top ' + top_n + ' Countries with Highest Value of Exported Goods in ' + Year_selection"
        }
      },
      "params":[
        {
          "name": "continent_highlight",
          "select": {"type": "point", "fields": ["Continent"]},
          "bind": "legend"
        }
      ],
      "width": 1000,
      "height": 400,
      "layer": [
        {
          "transform": [
            {
              "filter": "datum.Year == Year_selection"
            },
            {
              "sort": [
                {
                  "field": "Export (US$ Billions)", 
                  "order": "descending" 
                }
              ],
              "window": [
                {
                  "op": "rank",
                  "as": "topN"
                }
              ],
              "groupby": ["Year"]
            },
            {
              "filter": "datum.topN <= top_n"
            }
          ],
          "mark": "bar",
          "encoding": {
            "x": {
              "field": "Export (US$ Billions)",
              "type": "quantitative",
              "title": "Value of Exported Goods (US$ Billion)",
              "aggregate": "max"
            },
            "y": {
              "field": "Country",
              "type": "nominal",
              "title": "Country",
              "sort": "-x"
            },
            "color": {
              "field": "Continent",
              "type": "nominal",
              "title": "Continent",
              "scale": {
                "domain": [
                  "North America",
                  "South America",
                  "Europe",
                  "Africa",
                  "Asia",
                  "Oceania"
                ],
                "range": [
                  "#e41a1c",
                  "#984ea3",
                  "#ff7f00",
                  "#a6cee3",
                  "#377eb8",
                  "#a65628"
                ]
              },
              "legend": {
                "padding": 10
              }
            },
            "opacity": {
              "condition": {"param": "continent_highlight", "value": 0.6},
              "value": 0.2
            }, 
            "tooltip": [
              {"field": "Country", "type": "nominal", "title": "Country"},
              {"field": "Continent", "type": "nominal", "title": "Continent"},
              {"field": "Year", "type": "quantitative", "title": "Year"},
              {"field": "Export (US$ Billions)", "type": "quantitative", "title": "Value of Exported Goods (US$ Billion)"}
            ]
          }
        }
      ]
    }
  ],
  "config": {
    "axis": {
      "grid": false
    }
  }
}
